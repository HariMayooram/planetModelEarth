<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feed View</title>
  <style>
    /* 下拉菜单样式 */
    #apiFeeds {
      width: 200px;
      padding: 8px;
      font-size: 16px;
      margin: 10px;
      background-color: #f0f0f0;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    @media (max-width: 760px) {
      table, th, td {
        display: block;
        width: 100%;
      }
      td {
        border-bottom: 1px solid #ddd;
      }
    }

    /* CORS 提示 */
    #corsLink {
      display: none;
      margin: 12px 0 32px 0;
      background-color: #444;
      color: white;
      padding: 8px 20px;
      margin-right: 10px;
    }

    #corsLink a {
      color: #ffffff;
      text-decoration: underline;
    }
  </style>
</head>
<body>

  <select id="apiFeeds" onchange="updateFeed(this.value)">
  </select>

  <div id="resultJson"></div>
  <div id="resultFull"></div>

  <!-- CORS 提示信息 -->
  <div id="corsLink">
    <span>IMPORTANT</span>
    <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="passthrough" onclick="alert('Remember to refresh the page after enabling CORS passthrough!')">Turn on CORS passthrough</a> (then refresh this page)
  </div>

  <script>
    const SPREADSHEET_ID = '1jQTlXWom-pXvyP9zuTcbdluyvpb43hu2h7anxhF5qlQ';  // Google Sheets ID
    const RANGE = 'A2:J';  // 数据范围
    const API_KEY = 'AIzaSyC211F_ub1nAGr2Xv-wJGeulMg4nPzG1yE';  // API 密钥

    // 获取 Google Sheet 数据
    function getGoogleSheetData() {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                populateDropdown(data.values);
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // 填充下拉菜单
    function populateDropdown(feedData) {
        const selectElement = document.getElementById('apiFeeds');
        selectElement.innerHTML = '';

        const defaultOption = document.createElement('option');
        defaultOption.value = "none";
        defaultOption.textContent = "Select a feed.......";
        selectElement.appendChild(defaultOption);

        feedData.forEach(feed => {
            const option = document.createElement('option');
            option.value = feed[0]; // Feed 名称
            option.textContent = feed[0];
            selectElement.appendChild(option);
        });

        // 通过 localStorage 恢复上次的选择
        const savedFeed = localStorage.getItem('selectedFeed');
        if (savedFeed) {
            selectElement.value = savedFeed;
            updateFeed(savedFeed);  // 自动加载上次选中的 Feed
        }
    }

    // 更新 Feed
    // Test for CORS 
    function fetchWithCORS(url) {
        console.log('Making CORS request to:', url);  // 打印要请求的 URL
        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';  // 使用 CORS 代理

        fetch(proxyUrl + url)
            .then(response => {
                console.log('CORS Response Status:', response.status);  // 打印返回的 HTTP 状态
                return response.json();  // 解析 JSON 数据
            })
            .then(data => {
                console.log('CORS Response Data:', data);  // 打印返回的数据
                displayData(data);  // 显示数据
            })
            .catch(error => {
                console.error('CORS 请求失败:', error);  // 打印请求失败的错误信息
            });
    // }
    // function updateFeed(feedValue) {
    //     console.log(`Selected feed: ${feedValue}`);  // 打印选中的 Feed 名称

    //     // 清空之前的数据
    //     document.getElementById('resultJson').innerHTML = '';
    //     document.getElementById('resultFull').innerHTML = '';

    //     localStorage.setItem('selectedFeed', feedValue);  

    //     fetchFeedDetails(feedValue).then(feedDetails => {
    //         if (feedDetails) {
    //             const { url, cors } = feedDetails;
    //             console.log(`Feed URL: ${url}, CORS Needed: ${cors}`);  // 打印 Feed URL 和 CORS 需求
    //             if (cors === "TRUE") {
    //                 console.log('CORS Needed');
    //                 showCORSLink();  // 显示 CORS 提示
    //             } else {
    //                 console.log('No CORS Needed');
    //                 fetchData(url);  // 直接请求数据
    //             }
    //         }
    //     }).catch(error => {
    //         console.error('Error fetching feed details:', error);
    //     });
    // }

    // 获取 Feed 详细信息
    function fetchFeedDetails(feedValue) {
        return new Promise((resolve, reject) => {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const feedRow = data.values.find(row => row[0] === feedValue);
                    if (feedRow) {
                        resolve({
                            url: feedRow[9],  // Feed URL
                            cors: feedRow[8]  // 是否需要 CORS
                        });
                    } else {
                        reject('Feed not found');
                    }
                })
                .catch(error => reject(error));
        });
    }

    // 显示 CORS 提示信息
    function showCORSLink() {
        document.getElementById('corsLink').style.display = 'block';  // 显示 CORS 提示
    }

    // 请求数据（无需 CORS）
    function fetchData(url) {
        console.log('CORS No needed URL:', url);
        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log('直接请求的数据:', data);
                displayData(data);  // 显示数据
            })
            .catch(error => {
                console.error('数据请求失败:', error);
            });
    }

    // 显示数据
    function displayData(data) {
        const resultJson = document.getElementById('resultJson');
        resultJson.innerHTML = JSON.stringify(data, null, 2);  // 显示 JSON 数据
    }

    // 页面加载时调用获取 Google Sheet 数据的函数
    document.addEventListener('DOMContentLoaded', function() {
        getGoogleSheetData();  // 调用获取数据的函数
    });

    // 监听 CORS 刷新按钮点击事件
    document.addEventListener('click', function(event) {
        if (event.target.id === 'corsLink' && event.target.tagName === 'A') {
            alert("CORS passthrough enabled. Please refresh the page.");
        }
    });
  </script>

</body>
</html>